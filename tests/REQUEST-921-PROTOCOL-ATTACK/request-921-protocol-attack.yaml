---
  meta:
    author: "Christian S.J. Peron"
    enabled: true
    name: "request-921-protocol-attack.yaml"
    description: "Tests for protocol based attacks"
  tests:
    -
      test_title: "HTTP Request Smuggling Attack: rule 921100"
      stages:
        -
          stage:
            input:
              dest_addr: "127.0.0.1"
              method: "GET"
              port: 80
              headers:
                  Host: "localhost"
                  Transfer-Encoding: "fooo,sdfsdfsda"
              uri: "/"
            output:
              log_contains: "id \"921100\""
              status: 501
   # NB: still need a test for rule 921110
   -
      test_title: "HTTP Response splitting attack: rule 921120"
      stages:
        -
          stage:
            input:
              dest_addr: "127.0.0.1"
              method: "GET"
              port: 80
              headers:
                  Host: "localhost"
              uri: "/file.jsp?somevar=foobar%0d%0aContent-Length:%2002343432423<html>ftw</html>"
            output:
              status: 404
              log_contains: "id \"921120\""

    -
      test_title: "HTTP Response splitting attack: rule 921130"
      stages:
        -
          stage:
            input:
              dest_addr: "127.0.0.1"
              method: "GET"
              port: 80
              headers:
                  Host: "localhost"
                  Cookie: "oreo=munchmuch%0d%0a%0d%0a<HTML><title></title></HTML>"
              uri: "/"
            output:
              status: 200
              log_contains: "id \"921130\""
    -
      test_title: "HTTP Header Injection Attack via headers: rule: 921140" # NB: is this rule working right?
      stages:
        -
          stage:
            input:
              dest_addr: "127.0.0.1"
              method: "GET"
              port: 80
              headers:
                  Host: "localhost"
                  SomeHeader: "Headerdata\rInjectedHeader: response_splitting_code"
              uri: "/"
            output:
              status: 200
              log_contains: "id \"921140\""
    -
      test_title: "HTTP Header Injection Attack via payload: rule: 921150"
      stages:
        -
          stage:
            input:
              dest_addr: "127.0.0.1"
              method: "GET"
              port: 80
              headers:
                  Host: "localhost"
                  User-agent: "user agent"
              uri: "/script.jsp?variableX=bar&variable2=Y&%0d%0restofdata"
            output:
              status: 404
              log_contains: "id \"921150\""
    -
      test_title: "HTTP Header Injection Attack via payload: w/header detected rule: 921160"
      stages:
        -
          stage:
            input:
              dest_addr: "127.0.0.1"
              method: "GET"
              port: 80
              headers:
                  Host: "localhost"
                  User-agent: "user agent"
              # This trips 921160
              #uri: "/script_rule921160.jsp?variableX=bar&variable2=Y&%0d%0X-Forwarded-Host:%20foo.bar.com
              uri: "/script_rule921160.jsp?variableX=bar&variable2=Y&%0d%0Remote-addr%0d%0d%0d:%20foo.bar.com"
            output:
              status: 404
              log_contains: "id \"921160\""
    -
      test_title: "HTTP Header Injection Attack via payload: POST 921170"
      stages:
        -
          stage:
            input:
              dest_addr: "127.0.0.1"
              method: "POST"
              port: 80
              headers:
                  Host: "localhost"
              uri: "/someform.jsp"
              data: "variableX=bar&variable2=Y&var=sdfdsf&sdfds=%0d%0d%0d%0d%0a%0a%0Response_splitt_payload=restofdata"
            output:
              status: 404
              log_contains: "id \"921170\""

